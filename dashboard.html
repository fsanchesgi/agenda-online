<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard | TimelyPro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="dashboard-page">

<header class="dashboard-header">
  <h1>Dashboard TimelyPro</h1>
  <button onclick="logout()">Sair</button>
</header>

<main id="dashboard-content">
  <p>Carregando...</p>
</main>

<script src="auth.js"></script>

<script>
async function loadDashboard() {
  const session = await requireAuth();
  const userId = session.user.id;

  const { data, error } = await supabaseClient
    .from("assinaturas")
    .select(`
      status,
      inicio,
      fim,
      plans (
        name,
        features
      )
    `)
    .eq("perfil_id", userId)
    .single();

  const container = document.getElementById("dashboard-content");

  if (error || !data) {
    container.innerHTML = "Erro ao carregar assinatura.";
    return;
  }

  const agora = new Date();
  const fim = data.fim ? new Date(data.fim) : null;
  const plano = data.plans.name;

  /* ========= PLANO EXPIRADO ========= */
  if (fim && fim < agora) {
    container.innerHTML = `
      <h2>Plano expirado</h2>
      <p>Seu plano venceu. FaÃ§a upgrade para continuar.</p>
      <a href="planos.html" class="btn-primary">Renovar plano</a>
    `;
    return;
  }

  /* ========= FREE ========= */
  if (plano === "free") {
    container.innerHTML = `
      <h2>Plano Free</h2>
      <button>ðŸ“… Criar agendamento</button>
      <div class="locked">ðŸ”’ RelatÃ³rios</div>
      <div class="locked">ðŸ”’ Financeiro</div>
      <a href="planos.html">Fazer upgrade</a>
    `;
  }

  /* ========= PRO ========= */
  if (plano === "pro") {
    container.innerHTML = `
      <h2>Plano Pro</h2>
      <button>ðŸ“… Criar agendamento</button>
      <button>ðŸ“Š RelatÃ³rios</button>
      <div class="locked">ðŸ”’ Financeiro</div>
      <a href="planos.html">Upgrade Premium</a>
    `;
  }

  /* ========= PREMIUM ========= */
  if (plano === "premium") {
    container.innerHTML = `
      <h2>Plano Premium</h2>
      <button>ðŸ“… Criar agendamento</button>
      <button>ðŸ“Š RelatÃ³rios</butto
