<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Agendar Horário | TimelyPro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Agende seu horário com os profissionais do TimelyPro" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="agenda-page">

<header>
  <a href="index.html">
    <img src="images/timelypro-logo.png" class="logo" />
  </a>
  <h1>Agendamento de Horário</h1>
</header>

<main>
  <section class="agenda-card">
    <h2>Escolha um profissional</h2>
    <select id="profissional"></select>

    <h2>Seus dados</h2>
    <input type="text" id="nome" placeholder="Seu nome" required />
    <input type="text" id="whatsapp" placeholder="WhatsApp" required />
    <input type="datetime-local" id="datahora" required />

    <button onclick="agendar()" class="btn-primary">Agendar</button>
  </section>
</main>

<footer class="agenda-footer">© 2025 TimelyPro</footer>

<script>
const SUPABASE_URL = "https://uqwbduinwugaqexsvkxc.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxd2JkdWlud3VnYXFleHN2a3hjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3MTk5MjMsImV4cCI6MjA4MTI5NTkyM30._GzXlkNAvqbevYjmi-crhvSKGQQfX3yjzTWT5PTvIxE";

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Captura o slug do estabelecimento na URL
const slug = new URLSearchParams(window.location.search).get("slug");
let estabelecimentoId;

// Carrega dados do estabelecimento e profissionais
async function carregarEstabelecimento() {
  const { data: estab, error: errEstab } = await supabaseClient
    .from("estabelecimentos")
    .select("*")
    .eq("slug", slug)
    .single();

  if (errEstab || !estab) {
    alert("Estabelecimento não encontrado!");
    return;
  }

  estabelecimentoId = estab.id;

  // Carrega profissionais ativos
  const { data: profs, error: errProfs } = await supabaseClient
    .from("profissionais")
    .select("*")
    .eq("estabelecimento_id", estabelecimentoId)
    .eq("ativo", true);

  if (errProfs) {
    alert("Erro ao carregar profissionais");
    return;
  }

  const select = document.getElementById("profissional");
  select.innerHTML = "";

  profs.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p.id;
    opt.textContent = p.nome + (p.especialidade ? ` - ${p.especialidade}` : "");
    select.appendChild(opt);
  });
}

// Função de agendamento com bloqueio de conflito
async function agendar() {
  const profissional_id = document.getElementById("profissional").value;
  const cliente_nome = document.getElementById("nome").value.trim();
  const cliente_whatsapp = document.getElementById("whatsapp").value.trim();
  const data_hora = document.getElementById("datahora").value;

  if (!cliente_nome || !cliente_whatsapp || !data_hora) {
    alert("Preencha todos os campos.");
    return;
  }

  // Verificar conflito
  const { data: conflitos } = await supabaseClient
    .from("agendamentos")
    .select("*")
    .eq("profissional_id", profissional_id)
    .eq("data_hora", data_hora);

  if (conflitos.length > 0) {
    alert("Horário já reservado, escolha outro.");
    return;
  }

  // Inserir agendamento
  const { error } = await supabaseClient.from("agendamentos").insert({
    profissional_id,
    cliente_nome,
    cliente_whatsapp,
    data_hora
  });

  if (error) {
    alert("Erro ao salvar agendamento: " + error.message);
    return;
  }

  alert("Agendamento realizado com sucesso!");
  document.getElementById("nome").value = "";
  document.getElementById("whatsapp").value = "";
  document.getElementById("datahora").value = "";
}

// Executa ao carregar a página
carregarEstabelecimento();
</script>

</body>
</html>
